<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self';
                   style-src 'self' 'unsafe-inline';
                   img-src 'self' data:;">
    <title>Mihomo 链式代理 · 订阅转换器</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        body {
            background-color: #f0f2f5; /* c.body background */
            font-family: "Segoe UI", sans-serif; /* c.body font */
            margin: auto; /* c.body margin for centering */
            padding: 20px; /* c.body padding */
            max-width: 960px; /* c.body max-width */
            color: #333; /* c.body color */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #333; /* c.header color */
            margin-bottom: 24px; /* c.header margin */
            font-size: 28px; /* c.header font-size */
            font-weight: bold;
            width: 100%;
        }

        .config-area, .response-area { /* These act as .section from chatgpt.html */
            width: 100%;
            box-sizing: border-box;
            background-color: #ffffff; /* c.section background */
            border-radius: 12px; /* c.section border-radius */
            padding: 20px; /* c.section padding */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05); /* c.section box-shadow */
            margin-bottom: 20px; /* c.section margin-bottom */
        }

        .response-area { /* Specific styling for response area */
            background-color: #f4f6fa; /* c.response-section background */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04); /* c.response-section box-shadow */
            border: 1px solid #e0e0e0; /* 添加一个1像素宽、实线、浅灰色的边框 */
        }

        .sub-section { /* Adopted from chatgpt.html's .sub-section style */
            padding: 16px;
            border-left: 4px solid #d0d7de;
            margin-top: 16px;
            background-color: #fafbfc;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .sub-section:first-child {
            margin-top: 0;
        }

        label.form-label { /* For titles within sub-sections */
            display: block;
            font-weight: bold;
            margin-bottom: 10px; /* Increased margin for clarity */
            color: #333;
            font-size: 1.05em; /* Slightly larger for sub-section titles */
        }

        input[type="url"],
        input[type="text"] { /* Styling from chatgpt.html */
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            margin-top: 5px;
            margin-bottom: 8px; /* c.input margin-bottom */
            font-size: 1em;
        }
        input[type="url"]:disabled,
        input[type="text"]:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Slider Toggle Switch Styles from chatgpt.html */
        .toggle-group { /* Corresponds to c.toggle-line */
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .switch { /* c.switch */
            position: relative;
            display: inline-block;
            width: 40px; /* 原为 46px, 略微减小宽度 */
            height: 20px; /* 原为 24px, 减小高度 */
            flex-shrink: 0;
            margin-right: 10px;
        }
        .slider { /* c.slider */
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px; /* 对应新的高度，保持药丸形状 */
        }
        .slider:before { /* c.slider:before */
            position: absolute;
            content: "";
            height: 16px; /* 原为 18px (计算方式: 新高度20px - 2*内边距2px) */
            width: 16px;  /* 原为 18px */
            left: 2px;    /* 原为 3px, 减小内边距 */
            bottom: 2px;  /* 原为 3px */
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { /* c.input:checked + .slider */
            background-color: #3b82f6;
        }
        input:focus + .slider { /* Retained focus style */
            box-shadow: 0 0 1px #3b82f6;
        }
        input:checked + .slider:before { /* c.input:checked + .slider:before */
            transform: translateX(20px); /* 原为 22px (计算方式: 新宽度40px - 滑块宽度16px - 2*内边距2px) */
        }

        .switch-label-text { /* Corresponds to c.toggle-label */
            margin-left: 0; /* margin-right on .switch handles spacing */
            font-weight: bold;
            color: #333;
            cursor: pointer;
            font-size: 1em;
        }

        .input-description, .conditional-text { /* Style for descriptive texts */
            font-size: 0.85em;
            color: #777; /* c.conditional-text color */
            margin-top: 5px;
            margin-bottom: 10px;
        }
        /* Specific conditional text alignment if needed */

        #manualPairsSection {
            margin-top: 5px;
            padding-top: 5px;
        }
        .manual-pair-dynamic-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .manual-pair-dynamic-row .row-number-cell {
            flex: 0 0 20px;
            text-align: right;
            color: #777;
            font-size: 0.9em;
        }
        .manual-pair-dynamic-row .input-cell { flex: 1; }
        .manual-pair-dynamic-row .dialer-proxy-label-cell {
            flex: 0 0 auto; padding: 0 5px; color: #555; font-size: 0.9em;
        }
        .manual-pair-dynamic-row .actions-cell {
            flex: 0 0 auto; display: flex; gap: 5px;
        }

        .action-button-inline { /* For + / - buttons, matching c.action-button-inline */
            padding: 4px 8px;
            font-size: 0.9em;
            border-radius: 6px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
            line-height: 1;
        }
        .action-button-inline:hover:not(:disabled) { background-color: #e0e0e0; }
        .action-button-inline.add { color: #27ae60; border-color: #a0d4b4;} /* c.add style */
        .action-button-inline.add:hover:not(:disabled) { background-color: #e6ffed; }
        .action-button-inline.remove { color: #c0392b; border-color: #e6a8a1;} /* c.remove style */
        .action-button-inline.remove:hover:not(:disabled) { background-color: #fdd; }
        .action-button-inline:disabled { /* c.add:disabled style */
            background-color: #e9ecef;
            color: #adb5bd;
            border-color: #ced4da;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .button-primary { /* Corresponds to c.generate-button */
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px; /* c.generate-button padding */
            border-radius: 8px; /* c.generate-button border-radius */
            width: 100%;
            font-size: 1em; /* c.generate-button font-size */
            margin-top: 20px; /* c.generate-button margin-top */
            cursor: pointer;
            font-weight: 600; /* Added for consistency with other buttons */
            transition: background-color 0.2s ease;
        }
        .button-primary:hover:not(:disabled) { background-color: #2563eb; }
        .button-primary:disabled { /* c.generate-button:disabled */
            background-color: #cbd5e1;
            cursor: not-allowed;
        }

        .result-buttons { /* c.result-buttons */
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .button-secondary { /* Corresponds to c.action-button or c.button-secondary */
            background-color: #6366f1; /* c.action-button background */
            color: white;
            padding: 10px 16px; /* c.action-button padding */
            border: none;
            border-radius: 8px; /* c.action-button border-radius */
            cursor: pointer;
            font-weight: 600; /* c.action-button font-weight */
            flex: 1 1 auto; /* Adapting for flexible width */
            text-align: center;
            transition: background-color 0.2s ease;
        }
        .button-secondary:hover:not(:disabled) { background-color: #4f46e5; }
        .button-secondary:disabled { /* c.action-button:disabled */
            background-color: #d1d5db;
            color: #787f84; /* Adjusted for better visibility on lighter grey */
            cursor: not-allowed;
        }

        #feedbackMessage { /* c.feedback-message */
            margin-top: 12px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            text-align: center;
        }
        .feedback-success {
            background-color: #e6ffed;
            color: #2e7d32;
        }
        .feedback-error {
            background-color: #fdecea;
            color: #b00020;
        }
        .feedback-info {
            background-color: #e0f2fe;
            color: #0288d1;
        }

        #generatedUrl {
            background-color: #fff;
            border: 1px solid #ccc;
            font-size: 0.95em;
            word-break: break-all;
            margin-bottom: 5px;
        }
        .hidden { display: none !important; }
        .error-message {
            color: #b00020;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .footer-link {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9em;
            color: #7f8c8d;
            width: 100%;
        }
        .footer-link a { color: #3498db; text-decoration: none; }
        .footer-link a:hover { text-decoration: underline; }

    </style>
</head>
<body>
    <h1>Mihomo 链式代理 · 订阅转换器</h1>

    <div class="config-area">
        <div class="sub-section" id="subscriptionLinkGroup">
            <label for="remoteUrl" class="form-label">订阅链接</label>
            <input type="url" id="remoteUrl" placeholder="请输入包含前置和落地节点的订阅配置链接" required>
            <small class="input-description">建议通过订阅转换服务合并生成。如使用OpenClash，可点击配置订阅➡更新，在运行日志➡插件日志中找到</small>
        </div>

        <div class="sub-section" id="dialerConfigGroup">
            <label class="form-label">链式配置</label>
            <div id="manualPairsSection">
                <div id="manualPairsInputsContainer">
                </div>
            </div>
            <div class="toggle-group">
                <label class="switch">
                    <input type="checkbox" id="configModeSwitchInput">
                    <span class="slider"></span>
                </label>
                <label class="switch-label-text" for="configModeSwitchInput">自动配置</label>
            </div>
            <small id="autoModeText" class="input-description conditional-text hidden">当前为自动配置模式，节点/组命名需符合自动配置命名规范</small>
            <small id="manualModeText" class="input-description conditional-text">默认为手动配置模式，请输入落地/前置节点名称</small>
        </div>

        <div class="sub-section" id="serviceAddressGroup">
            <div class="toggle-group">
                 <label class="switch">
                    <input type="checkbox" id="customizeServiceUrlSwitchInput">
                    <span class="slider"></span>
                </label>
                <label class="switch-label-text" for="customizeServiceUrlSwitchInput">自定义服务根地址</label>
            </div>
            <input type="url" id="serviceUrl" placeholder="请输入本服务根地址，注意本机/内/外网的可访问性" style="margin-top: 8px;">
            <small class="input-description">本转换服务的访问地址，一般默认自动填充即可</small>
        </div>

        <button id="generateLinkButton" class="button-primary">🔄 生成</button>
    </div>

    <div class="response-area">
        <input type="text" id="generatedUrl" readonly placeholder="生成后的配置链接">
        <div class="result-buttons">
            <button id="copyUrlButton" class="button-secondary">🔗 复制</button>
            <button id="openUrlButton" class="button-secondary">↗️ 打开</button>
            <button id="downloadConfigButton" class="button-secondary">📄 下载</button>
        </div>

        <div class="feedback-and-log-toggle-line" style="display: flex; align-items: center; margin-top: 12px; margin-bottom: 8px;">
            <button id="toggleLogButton" title="显示/隐藏详细日志" style="background: none; border: none; padding: 0 8px 0 0; cursor: pointer; font-size: 1.2em; color: #6c757d; line-height: 1;">▶</button>
            <div id="feedbackMessage" class="feedback-message feedback-info" style="flex-grow: 1; margin: 0;">等待操作...</div>
        </div>
        <div id="logContainer" class="hidden" style="overflow-y: auto; border: 1px solid #e0e0e0; padding: 10px; background-color: #f8f9fa; font-size: 0.85em; line-height: 1.6; margin-top: 8px;">
            </div>

    </div>

    <div class="footer-link">
        <p>项目地址: <a href="https://github.com/slackworker/chain-subconverter" target="_blank" rel="noopener noreferrer">https://github.com/slackworker/chain-subconverter</a></p>
    </div>

    <script src="script.js"></script>
</body>
</html>