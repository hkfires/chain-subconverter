# chain-subconverter

A sub-converter for Mihomo chain-proxy configuration.

-----

## Mihomo 链式代理 · 订阅转换器：简明使用指南

### 核心功能

本工具旨在帮助您为Mihomo（或其他兼容客户端）创建链式代理订阅。它通过修改您的原始订阅配置，为指定的“落地节点”设置“前置节点/组”作为其 `dialer-proxy`，从而实现自定义的网络流量路径。

-----

## 💡 项目简介

Mihomo 内核拥有强大的分流功能和成熟的生态系统。我们可以通过订阅他人维护的规则模板来实现高精度的分流，同时保持低维护成本。

然而，市面上常用的订阅转换工具普遍**不支持链式代理的配置**，并且会过滤掉 `dialer-proxy` 字段。这意味着，如果你想定期更新订阅配置，同时又需要使用链式代理功能，常常需要手搓 YAML 文件，非常麻烦。

**`chain-subconverter` 项目正是为解决这个问题而生！**

它提供了一个**一键 Docker 部署**的后端服务，并配套了**易用的前端配置界面**。通过前端界面，您可以方便地为原始订阅中的“落地节点”配置“前置代理节点/代理组”，并生成包含这些链式代理设置的新订阅链接。每次订阅更新（通过访问生成的新链接），链式配置都将动态应用。

  * **Mihomo `dialer-proxy` 特性参考文档：** [https://wiki.metacubex.one/config/proxies/dialer-proxy/](https://wiki.metacubex.one/config/proxies/dialer-proxy/)
  * **推荐规则模板**（搭配自动模式使用）： [https://github.com/Aethersailor/Custom\_OpenClash\_Rules](https://github.com/Aethersailor/Custom_OpenClash_Rules)

-----

## 🚀 部署 Docker 后端服务

部署 `chain-subconverter` 后端服务非常简单，只需一条 Docker 命令。前端配置界面已包含在服务中。

**在部署前，你需要准备：**

1.  **已安装 Docker 的设备**，并且该设备可以被您需要使用此转换服务的客户端（例如 OpenClash）访问到。可以是内网的 OpenWrt 路由器、NAS，或者是公网 VPS。

**Docker 部署命令：**

```bash
docker run -d \
  --name chain-subconverter \
  -p 11200:11200 \
  --restart unless-stopped \
  ghcr.io/slackworker/chain-subconverter:latest
```

### 命令说明

  * `docker run -d`: 在后台运行容器。
  * `--name chain-subconverter`: 给容器指定一个易于识别的名称。
  * `-p 11200:11200`: 将您设备（宿主机）的 `11200` 端口映射到容器内部的 `11200` 端口。您可以修改前面的宿主机端口 (`11200`) 为其他未被占用的端口（例如 `-p 8080:11200`，则通过宿主机的8080端口访问）。
  * `--restart unless-stopped`: 设置容器重启策略。除非您手动停止它，否则它会在设备重启或容器异常退出时自动尝试启动。
  * `ghcr.io/slackworker/chain-subconverter:latest`: 这是您将要运行的 Docker 镜像。

-----

### 部署步骤：

1.  **复制并粘贴配置好的 `docker run` 命令**到您的设备终端/控制台，然后执行。
    * *注意*：部分终端不支持 `\`（反斜杠）作为换行符。如果遇到问题，请将命令中的 `\` 删除，并将所有内容合并为一行再执行。
2.  **检查容器是否启动成功：**
    * 在终端输入 `docker ps`。如果看到名为 `chain-subconverter` 的容器，并且其 `STATUS` 列显示为 `Up` (通常带有运行时间，例如 `Up 2 minutes`)，则说明服务已成功启动。

-----

## 🖥️ 使用网页前端配置订阅

后端服务成功运行后，您可以通过浏览器访问其内置的前端配置界面。

**访问地址**：`http://<运行Docker设备的IP或域名>:映射的宿主机端口/`
例如，如果您将容器的11200端口映射到宿主机的11200端口，并且运行Docker的设备IP是 `192.168.1.100`，则访问 `http://192.168.1.100:11200/`。

### 核心配置流程

1.  **输入原始订阅链接**:
    * 在“订阅链接”区域的输入框中粘贴您的原始订阅链接。
    * **要求**：此链接必须有效，且其内容应包含所有您计划用作“落地节点”和“前置节点/组”的代理信息。

2.  **配置链式节点对**:
    * **选项A (自动识别)**:
        * 点击“**自动识别并填充节点对**”按钮。
        * 系统将尝试根据节点命名规范（详见下方“节点命名规范”）从您的原始订阅中识别并自动填充下方的节点对列表。
        * 请关注界面下方的反馈信息和详细日志，了解识别过程和结果。
    * **选项B (手动配置)**:
        * 在“落地节点 与 前置节点/组 名称”区域的输入行中，手动填写“落地节点名称”和对应的“前置节点/组名称”。
        * 可通过行末的 "+/-" 按钮灵活增删配置行 (最多10对)。
    * **重要**：无论是自动填充还是手动输入，都请**仔细检查**所有节点对是否准确无误，并根据您的实际需求进行编辑调整。

3.  **(可选) 自定义服务根地址**:
    * 通常情况下，前端会自动填充正确的服务根地址。仅当自动填充的地址不适用于您的网络环境时（例如，通过特定的域名或反向代理访问后端服务），才需启用“自定义服务根地址”开关并手动输入后端服务的实际可访问URL。

4.  **生成和验证配置**:
    * 完成上述配置后，点击页面底部的“**生成**”按钮。
    * 系统会将您的原始订阅链接和配置的节点对信息发送到后端进行有效性验证。
    * **验证成功**：界面下方的“生成后的配置链接”输入框中将显示一个新的、包含链式配置参数的服务URL（指向本转换器的 `/subscription.yaml` 端点）。同时，“复制”、“打开”、“下载”按钮将被激活。
    * **验证失败**：请仔细阅读主反馈行和详细日志区的错误提示，检查您的原始订阅链接或节点对配置是否正确，然后进行修改并重试。

5.  **使用生成的订阅链接**:
    * **复制**: 点击“复制”按钮，将生成的新服务URL粘贴到您的（支持dialer-proxy特性的）Mihomo内核客户端的订阅配置处。
    * **打开**: 点击“打开”按钮，可在浏览器新标签页预览转换后的YAML配置内容（如果内容直接显示）。
    * **下载**: 点击“下载”按钮，可直接下载转换后的 `.yaml` 配置文件，用于手动导入客户端。

### 节点命名规范 (为提高“自动识别”成功率)

为使“自动识别并填充节点对”功能达到最佳效果，建议您的订阅中节点和组的命名遵循以下约定：

* **落地节点识别**: 名称中需包含明确的落地标识，例如：“**落地**”、“**Landing**”等。
    * *示例*: `香港落地IEPL`, `US-Landing-01`
* **区域识别**: 节点和组的名称中应包含清晰的区域标识（例如：“**香港**”, “**HK**”, “**US**”, “**美国**”, “**日本**”, “**JP**”等）。工具会根据内置的区域关键字进行匹配。一个节点名称必须能被唯一识别到一个区域；如果匹配到多个不同区域或无法识别区域，则该节点可能无法被自动处理。
* **前置节点/组匹配**:
    * 当一个落地节点被识别并确定其区域后，工具会尝试在该区域内查找一个且仅一个名称与之区域匹配的**代理组**作为前置。
    * 如果未能找到唯一匹配的代理组，则会尝试在该区域内查找一个且仅一个名称与之区域匹配的**代理节点**（非落地节点自身）作为前置。
    * 如果找到多个匹配的组或节点，或完全找不到匹配项，则该落地节点的自动配置可能会失败。
* **关键字匹配规则**:
    * 对于包含英文字母的关键字（如 "HK", "Landing"），将进行忽略大小写、全词匹配（确保前后为非英文字母的边界）。
    * 对于纯中文等非英文字符的关键字（如 "香港", "落地"），将进行忽略大小写的子字符串包含匹配。

### 关键注意事项

* **自动识别的辅助性**: “自动识别”功能是一个强大的辅助工具，但它高度依赖于您原始订阅的命名规范性。在复杂或不规范的命名情况下，其识别结果可能不完美。**强烈建议在使用自动识别后，务必人工核对并按需调整节点对配置。**
* **节点名称的精确性**: 无论是手动输入还是自动填充，请确保“落地节点”和“前置节点/组”的名称与您原始订阅中的名称**完全一致**（包括特殊符号，尽管匹配过程对大小写不敏感，但配置时建议保持一致）。
* **反馈与日志的重要性**:
    * 界面底部的主反馈行会简洁地提示当前操作的结果。
    * 点击反馈行左侧的三角箭头 (▶/▼) 可展开/收起详细的操作日志。当遇到问题，特别是自动识别不符合预期或配置验证失败时，详细日志是定位问题、理解处理过程的重要工具。

-----

## ✨ 测试与使用 (通过生成的链接)

当您在前端界面成功“生成”并获得一个新的服务URL后 (形如 `http://<设备IP或域名>:<端口>/subscription.yaml?remote_url=...&manual_pairs=...`)，这个URL就是您最终要在客户端中使用的订阅链接。

1.  **配置客户端**：
    将这个由前端界面生成的、包含参数的新服务URL粘贴到您的 OpenClash/Mihomo 客户端的**订阅地址**设置处。
2.  **验证效果**：
    更新客户端订阅后，检查对应的落地节点是否已成功应用了您指定的 `dialer-proxy` (前置代理)。您也可以直接在浏览器中访问这个新服务URL，查看其输出的YAML内容，确认 `dialer-proxy` 是否已正确添加，以及落地节点是否已从其可能原属的前置组中移除（以避免递归）。

通过这种方式，您的客户端将始终获取到经过链式代理转换的配置，并且在原始订阅内容更新时，链式配置也会被重新动态应用。

-----

## 🚧 已知问题与未来计划

* **远程部署安全**：当前项目设计主要针对本地或受信任网络环境部署。若需公网部署，请务必自行配置反向代理并做好安全防护（如身份验证、HTTPS加密等）。
* **自动识别规则优化**：自动识别节点的匹配逻辑和关键字库将根据用户反馈和实际使用情况持续优化。
* **(未来)**：可能会使用js重构整个项目。

-----

## 📜 许可证

本项目基于 MIT 许可证发布。

-----